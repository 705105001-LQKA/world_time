import 'dart:async';

import 'package:flutter/material.dart';
import 'package:get/get.dart';
import 'package:intl/intl.dart';
import 'package:timezone/timezone.dart' as tz;

import '../controllers/time_controller.dart';
import 'city_search_page.dart';
import '../widgets/city_time_row.dart';

class HomePage extends StatefulWidget {
  const HomePage({super.key});

  @override
  State<HomePage> createState() => _HomePageState();
}

class _HomePageState extends State<HomePage> {
  final TimeController controller = Get.put(TimeController());
  final RxString searchQuery = ''.obs;
  final Rx<DateTime> selectedDate = DateTime.now().obs;

  // ScrollController cho ListView d·ªçc
  final ScrollController listScrollController = ScrollController();

  // Map gi·ªØ ScrollController theo cityId (·ªü ƒë√¢y d√πng cityName l√†m key)
  final Map<String, ScrollController> _rowControllers = {};
  bool _isSyncing = false;

  // l∆∞u t·ªâ l·ªá offset g·∫ßn nh·∫•t ƒë·ªÉ ƒë·ªìng b·ªô controllers m·ªõi attach
  double _lastRatio = 0.0;

  late tz.Location hcmLocation;

  // Gi·ªõi h·∫°n s·ªë th√†nh ph·ªë hi·ªÉn th·ªã
  static const int _kMaxCities = 15;

  @override
  void initState() {
    super.initState();
    hcmLocation = tz.getLocation('Asia/Ho_Chi_Minh');

    // G·ªçi updateTimes ngay
    controller.updateTimes();

    // CƒÉn ch·ªânh t·ªõi ƒë·∫ßu ph√∫t k·∫ø ti·∫øp
    final now = DateTime.now();
    final nextTick = DateTime(now.year, now.month, now.day, now.hour, now.minute).add(const Duration(minutes: 1));
    final initialDelay = nextTick.difference(now);

    Future.delayed(initialDelay, () {
      controller.updateTimes();
      setState(() {}); // c·∫≠p nh·∫≠t utcNow m·ªói ph√∫t

      Timer.periodic(const Duration(minutes: 1), (_) {
        controller.updateTimes();
        setState(() {}); // bu·ªôc build l·∫°i ƒë·ªÉ utcNow m·ªõi
      });
    });
  }

  @override
  void dispose() {
    // Dispose m·ªçi controller trong Map
    for (final c in _rowControllers.values) {
      try {
        c.dispose();
      } catch (_) {}
    }
    listScrollController.dispose();
    super.dispose();
  }

  // ƒë·∫£m b·∫£o c√≥ controller cho cityId; t·∫°o m·ªõi n·∫øu c·∫ßn v√† add listener
  ScrollController _ensureControllerFor(String cityId) {
    if (!_rowControllers.containsKey(cityId)) {
      final c = ScrollController();
      c.addListener(() => _onRowScroll(cityId));
      _rowControllers[cityId] = c;
    }
    return _rowControllers[cityId]!;
  }

  // remove/dispose controller cho cityId (g·ªçi khi x√≥a city)
  void _removeControllerFor(String cityId) {
    final c = _rowControllers.remove(cityId);
    if (c != null) {
      try {
        c.dispose();
      } catch (_) {}
    }
  }

  // Trim controllers ƒë·ªÉ ch·ªâ gi·ªØ nh·ªØng key ƒëang hi·ªÉn th·ªã (avoid leak)
  void _trimControllersForDisplayed(List<String> displayedIds) {
    final toRemove = _rowControllers.keys.where((k) => !displayedIds.contains(k)).toList();
    for (final k in toRemove) {
      _removeControllerFor(k);
    }
  }

  // ƒë·ªìng b·ªô: khi m·ªôt controller thay ƒë·ªïi, c·∫≠p nh·∫≠t c√°c controller c√≤n l·∫°i
  void _onRowScroll(String sourceId) {
    final source = _rowControllers[sourceId];
    if (_isSyncing) return;
    if (source == null || !source.hasClients) return;

    _isSyncing = true;
    final offset = source.offset;
    final sourceMax = source.position.maxScrollExtent;
    final ratio = sourceMax > 0 ? (offset / sourceMax) : 0.0;
    _lastRatio = ratio;

    for (final entry in _rowControllers.entries) {
      final id = entry.key;
      final c = entry.value;
      if (id == sourceId) continue;
      if (!c.hasClients) continue;
      try {
        final targetMax = c.position.maxScrollExtent;
        final target = (targetMax * ratio).clamp(0.0, targetMax);
        c.jumpTo(target);
      } catch (_) {
        // ignore
      }
    }

    _isSyncing = false;
  }

  // Khi m·ªôt controller m·ªõi attach (sau build), ƒë·ªìng b·ªô n√≥ t·ªõi _lastRatio
  void _syncControllerIfNeeded(String cityId) {
    final c = _rowControllers[cityId];
    if (c == null) return;
    WidgetsBinding.instance.addPostFrameCallback((_) {
      if (!c.hasClients) return;
      try {
        final targetMax = c.position.maxScrollExtent;
        final target = (targetMax * _lastRatio).clamp(0.0, targetMax);
        c.jumpTo(target);
      } catch (_) {}
    });
  }

  @override
  Widget build(BuildContext context) {
    final nowSystem = DateTime.now();
    final nowUtc = DateTime.now().toUtc();
    final utcNow = DateTime.utc(
      selectedDate.value.year,
      selectedDate.value.month,
      selectedDate.value.day,
      nowUtc.hour,
      nowUtc.minute,
      nowUtc.second,
    );

    debugPrint('üîç System time: $nowSystem');
    debugPrint('üåê UTC time used in UI: $nowUtc');

    final hcmStart = tz.TZDateTime(hcmLocation, selectedDate.value.year,
        selectedDate.value.month, selectedDate.value.day, 0);
    final currentHour = tz.TZDateTime.from(nowUtc, hcmLocation).hour;
    final hourWidth = 60.0;
    final markerOffset = currentHour * hourWidth;

    return SafeArea(
      child: Scaffold(
        appBar: AppBar(
          title: const Text('World Time'),
          actions: [
            Obx(() {
              final hasSelection = controller.selectedStartUtc.value != null || controller.selectedEndUtc.value != null;
              return Row(
                children: [
                  if (hasSelection)
                    IconButton(
                      icon: const Icon(Icons.clear),
                      tooltip: 'H·ªßy ch·ªçn th·ªùi gian',
                      onPressed: () {
                        controller.selectedStartUtc.value = null;
                        controller.selectedEndUtc.value = null;
                      },
                    ),
                  IconButton(
                    icon: const Icon(Icons.add),
                    onPressed: () async {
                      await Get.to(() => CitySearchPage());
                      setState(() {});
                    },
                  ),
                ],
              );
            }),
          ],
        ),
        body: Column(
          children: [
            // Danh s√°ch th√†nh ph·ªë
            Expanded(
              child: Obx(() {
                final filtered = controller.cityTimes
                    .where((ct) => ct.cityName.toLowerCase().contains(searchQuery.value))
                    .toList();

                if (filtered.isEmpty) {
                  // clean up controllers if none displayed
                  _trimControllersForDisplayed([]);
                  return const Center(child: Text('No matching cities.'));
                }

                // prepare display list (limited)
                final displayCount = filtered.length > _kMaxCities ? _kMaxCities : filtered.length;
                final displayed = filtered.take(displayCount).toList();
                final displayedIds = displayed.map((c) => c.cityName).toList();

                // trim controllers not used anymore
                _trimControllersForDisplayed(displayedIds);

                return Stack(
                  children: [
                    ReorderableListView.builder(
                      key: const PageStorageKey('cityList'),
                      buildDefaultDragHandles: true,
                      scrollController: listScrollController,
                      itemCount: displayed.length,
                      onReorder: (oldIndex, newIndex) {
                        controller.reorderCity(oldIndex, newIndex);
                        setState(() {}); // c·∫≠p nh·∫≠t l·∫°i UI
                      },
                      itemBuilder: (context, index) {
                        final city = displayed[index];
                        final cityId = city.cityName;
                        final rowController = _ensureControllerFor(cityId);

                        _syncControllerIfNeeded(cityId);

                        return Dismissible(
                          key: ValueKey(cityId),
                          direction: DismissDirection.none, // kh√¥ng cho swipe xo√°
                          child: CityTimeRow(
                            cityTime: city,
                            utcNow: utcNow,
                            hcmStart: hcmStart,
                            scrollController: rowController,
                          ),
                        );
                      },
                      padding: const EdgeInsets.symmetric(horizontal: 0, vertical: 10),
                    ),

                    // banner n·∫øu b·ªã gi·ªõi h·∫°n
                    if (filtered.length > _kMaxCities)
                      Positioned(
                        left: 0,
                        right: 0,
                        bottom: 8,
                        child: Center(
                          child: Container(
                            padding: const EdgeInsets.symmetric(horizontal: 10, vertical: 6),
                            decoration: BoxDecoration(
                              color: Colors.black87,
                              borderRadius: BorderRadius.circular(20),
                            ),
                            child: Text(
                              'Ch·ªâ hi·ªÉn th·ªã $_kMaxCities th√†nh ph·ªë. X√≥a b·ªõt ƒë·ªÉ hi·ªÉn th·ªã th√™m.',
                              style: const TextStyle(color: Colors.white, fontSize: 12),
                            ),
                          ),
                        ),
                      ),
                  ],
                );
              }),
            ),
          ],
        ),
      ),
    );
  }
}