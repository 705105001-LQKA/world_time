import 'dart:ui';
import 'package:flutter/material.dart';
import 'package:flutter/services.dart';
import 'package:get/get.dart';
import 'package:timezone/timezone.dart' as tz;
import '../controllers/time_controller.dart';

class CitySearchPage extends StatefulWidget {
  const CitySearchPage({super.key});

  @override
  State<CitySearchPage> createState() => _CitySearchPageState();
}

class _CitySearchPageState extends State<CitySearchPage> {
  final TimeController controller = Get.find();
  final TextEditingController cityController = TextEditingController();
  final TextEditingController tzController = TextEditingController();
  final FocusNode tzFocusNode = FocusNode();
  final RxString selectedTimezone = ''.obs;

  final LayerLink _layerLink = LayerLink();
  final List<String> timezones = tz.timeZoneDatabase.locations.keys.toList()..sort();

  List<String> getSuggestions(String input) {
    final lower = input.toLowerCase();
    final matches = timezones.where((tz) => tz.toLowerCase().contains(lower)).toList();
    if ((lower.contains('hanoi') || lower.startsWith('ha_')) &&
        !matches.contains('Asia/Ho_Chi_Minh')) {
      matches.insert(0, 'Asia/Ho_Chi_Minh');
    }
    return matches;
  }

  void hideKeyboardButKeepFocus() {
    SystemChannels.textInput.invokeMethod('TextInput.hide');
  }

  bool _isDuplicateCity(String name, String tz) {
    final newName = name.trim().toLowerCase();
    final newTz = tz.trim().toLowerCase();

    for (var item in controller.cityTimes) {
      final itemName = item.cityName.trim().toLowerCase();
      final itemTz = item.timezone.trim().toLowerCase();

      if (itemName == newName || itemTz == newTz) return true;
    }

    return false;
  }

  @override
  void dispose() {
    cityController.dispose();
    tzController.dispose();
    tzFocusNode.dispose();
    super.dispose();
  }

  @override
  Widget build(BuildContext context) {
    // max consistent with controller.addCity
    const int maxCities = 15;

    return SafeArea(
      child: GestureDetector(
        behavior: HitTestBehavior.translucent,
        onTap: hideKeyboardButKeepFocus,
        child: Scaffold(
          resizeToAvoidBottomInset: true,
          appBar: AppBar(title: const Text('Add City')),
          body: LayoutBuilder(builder: (context, constraints) {
            return SingleChildScrollView(
              padding: EdgeInsets.only(
                left: 16,
                right: 16,
                bottom: MediaQuery.of(context).viewInsets.bottom + 16,
              ),
              child: ConstrainedBox(
                constraints: BoxConstraints(minHeight: constraints.maxHeight),
                child: IntrinsicHeight(
                  child: Column(
                    crossAxisAlignment: CrossAxisAlignment.start,
                    children: [
                      const Text('City Name', style: TextStyle(fontSize: 16)),
                      TextField(
                        controller: cityController,
                        decoration: const InputDecoration(hintText: 'Enter city name'),
                      ),
                      const SizedBox(height: 20),

                      const Text('Timezone', style: TextStyle(fontSize: 16)),
                      CompositedTransformTarget(
                        link: _layerLink,
                        child: RawAutocomplete<String>(
                          textEditingController: tzController,
                          focusNode: tzFocusNode,
                          optionsBuilder: (TextEditingValue textEditingValue) {
                            if (textEditingValue.text.isEmpty) return const Iterable<String>.empty();
                            return getSuggestions(textEditingValue.text);
                          },
                          displayStringForOption: (option) => option,
                          onSelected: (value) {
                            selectedTimezone.value = value;
                            tzController.text = value;
                          },
                          fieldViewBuilder: (context, controllerText, focusNode, onFieldSubmitted) {
                            return TextField(
                              controller: controllerText,
                              focusNode: focusNode,
                              decoration: const InputDecoration(
                                hintText: 'Search timezone (e.g. Asia/Tokyo)',
                              ),
                              onChanged: (value) => selectedTimezone.value = value,
                            );
                          },
                          optionsViewBuilder: (context, onSelected, options) {
                            return CompositedTransformFollower(
                              link: _layerLink,
                              showWhenUnlinked: false,
                              offset: const Offset(0, 40),
                              child: Material(
                                elevation: 4,
                                child: ConstrainedBox(
                                  constraints: const BoxConstraints(maxHeight: 240, maxWidth: 600),
                                  child: ListView.builder(
                                    padding: EdgeInsets.zero,
                                    shrinkWrap: true,
                                    itemCount: options.length,
                                    itemBuilder: (context, index) {
                                      final option = options.elementAt(index);
                                      return ListTile(
                                        title: Text(option),
                                        onTap: () => onSelected(option),
                                      );
                                    },
                                  ),
                                ),
                              ),
                            );
                          },
                        ),
                      ),

                      const Spacer(),
                      Center(
                        child: Obx(() {
                          final isFull = controller.cityTimes.length >= maxCities;
                          return ElevatedButton(
                            onPressed: isFull
                                ? () {
                              // Thông báo ngay khi cố gắng thêm khi đã đầy
                              controller.showSafeSnackbar(
                                'Giới hạn thành phố',
                                'Bạn chỉ có thể lưu tối đa $maxCities thành phố.',
                              );
                            }
                                : () {
                              final city = cityController.text.trim();
                              final tzValue = selectedTimezone.value.trim();

                              if (city.isEmpty || tzValue.isEmpty) {
                                controller.showSafeSnackbar('Missing info', 'Please enter both city name and timezone');
                                return;
                              }

                              if (_isDuplicateCity(city, tzValue)) {
                                controller.showSafeSnackbar('Duplicate', 'This city is already added');
                                return;
                              }

                              controller.addCity(city, tzValue);
                              debugPrint('➕ Added city: $city with timezone: $tzValue');
                              controller.updateTimes();
                              Get.back();
                            },
                            style: ElevatedButton.styleFrom(
                              backgroundColor: isFull ? Colors.grey : null,
                            ),
                            child: Text(isFull ? 'Limit reached' : 'Add City'),
                          );
                        }),
                      ),
                    ],
                  ),
                ),
              ),
            );
          }),
        ),
      ),
    );
  }
}